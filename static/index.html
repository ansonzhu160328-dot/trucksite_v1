<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é‡å¡ç«™ V1ï¼šæ–¹æ¡ˆä¸å›æŠ¥æµ‹ç®—</title>
<style>
:root{
  --bg:#eef2f6;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:rgba(15,23,42,0.12);

  --brand:#1f6fd6;         /* ä¸»æŒ‰é’®è“ */
  --nav:#2f3f57;           /* é¡¶æ æ·±è“ */
  --nav2:#2a3a52;

  --radius:10px;
  --shadow:0 6px 18px rgba(15,23,42,0.06);
  --font: "Microsoft YaHei","PingFang SC","Noto Sans SC",Arial,sans-serif;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  font-family:var(--font);
  color:var(--text);
}

/* é¡¶æ ï¼ˆå¯¹é½ Sora æ·±è“ï¼‰ */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  height:96px;
  padding:0 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(180deg,var(--nav) 0%,var(--nav2) 100%);
  border-bottom:1px solid rgba(255,255,255,0.08);
}
.topbar .title{
  margin:0;
  color:#fff;
  font-size:28px;
  font-weight:650;
  letter-spacing:0.5px;
}
.topbar .meta{
  color:rgba(255,255,255,0.78);
  font-size:12px;
  line-height:1.3;
  text-align:right;
}

/* ä¸»ä½“å®¹å™¨ */
.container{
  max-width:1280px;
  margin:18px auto 28px;
  padding:0 18px;
}
.grid{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:18px;
  align-items:start;
}

/* å¡ç‰‡ */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card h3{
  margin:0;
  padding:14px 16px;
  font-size:16px;
  font-weight:650;
  border-bottom:1px solid rgba(15,23,42,0.08);
  background:#fff;
}

/* è¡¨å•è¡Œï¼šå·¦ä¾§æ ‡ç­¾ + å³ä¾§è¾“å…¥ï¼ˆå¯¹é½ Sora ä¸­å°è¡¨å•é£ï¼‰ */
.form-row{
  display:grid;
  grid-template-columns:110px 1fr;
  gap:10px;
  align-items:center;
  padding:10px 16px;
}
.form-row label{
  font-size:13px;
  color:var(--muted);
}
input, select{
  width:100%;
  height:36px;
  padding:0 10px;
  border:1px solid rgba(15,23,42,0.14);
  border-radius:6px;
  outline:none;
  background:#fff;
}
input:focus, select:focus{
  border-color:rgba(31,111,214,0.55);
  box-shadow:0 0 0 3px rgba(31,111,214,0.12);
}

/* æŠ˜å åŒºï¼ˆé«˜çº§å‚æ•°ï¼‰ */
details{
  border-top:1px solid rgba(15,23,42,0.08);
}
summary{
  padding:12px 16px;
  cursor:pointer;
  color:var(--text);
  font-weight:600;
}

/* æŒ‰é’®åŒº */
.btnbar{
  display:flex;
  gap:10px;
  padding:12px 16px 16px;
}
.btn-primary{
  background:var(--brand);
  color:#fff;
  border:1px solid var(--brand);
  border-radius:6px;
  padding:10px 14px;
  font-weight:650;
  cursor:pointer;
}
.btn-primary:hover{ filter:brightness(0.95); }

.btn-ghost{
  background:#fff;
  color:var(--text);
  border:1px solid rgba(15,23,42,0.18);
  border-radius:6px;
  padding:10px 14px;
  font-weight:650;
  cursor:pointer;
}
.btn-ghost:hover{
  background:rgba(15,23,42,0.03);
}

/* å³ä¾§åˆ†åŒºæ ‡é¢˜æ¡ï¼ˆåƒ Sora é‚£ç§ sectionï¼‰ */
.section-title{
  margin:0;
  padding:14px 16px;
  font-size:16px;
  font-weight:650;
  border-bottom:1px solid rgba(15,23,42,0.08);
}

/* KPI è¡Œ */
.kpis{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  padding:14px 16px 16px;
}
.kpi{
  border:1px solid rgba(15,23,42,0.10);
  border-radius:8px;
  padding:12px;
  background:#fff;
}
.kpi .k{ font-size:12px; color:var(--muted); margin-bottom:8px; }
.kpi .v{ font-size:22px; font-weight:750; }
.kpi .s{ font-size:12px; color:var(--muted); margin-top:8px; }

/* è¡¨æ ¼ */
table{
  width:100%;
  border-collapse:collapse;
  margin:0;
}
th, td{
  border:1px solid rgba(15,23,42,0.12);
  padding:10px 10px;
  font-size:13px;
}
th{
  background:rgba(15,23,42,0.03);
  font-weight:650;
}
tbody tr:hover{ background:rgba(31,111,214,0.04); }

/* è¯¦æƒ…æµ‹ç®—å— */
pre{
  margin:0;
  padding:14px 16px 18px;
  background:#fff;
  border-top:1px solid rgba(15,23,42,0.08);
  font-size:12px;
  line-height:1.6;
  overflow:auto;
}

#layout{
  padding:14px 16px 18px;
  border-top:1px solid rgba(15,23,42,0.08);
}

#layout .layout-empty{
  color:var(--muted);
  font-size:12px;
}

/* å°å±é€‚é… */
@media (max-width: 980px){
  .grid{ grid-template-columns:1fr; }
  .kpis{ grid-template-columns:1fr 1fr; }
}

/* ====== A) å…¨å±€å­—ä½“ï¼šä¸­æ–‡ç”¨é›…é»‘ç³»ï¼Œæ•°å­—/è‹±æ–‡ä¼˜å…ˆ Times New Roman ====== */
:root{
  --font: "Times New Roman","Microsoft YaHei","PingFang SC","Noto Sans SC",Arial,sans-serif;

  /* å­—å·ä½“ç³»ï¼ˆä½ è¦â€œæœ‰å¤§æœ‰å°ä¸”åè°ƒâ€ï¼‰ */
  --fs-h1: 22px;
  --fs-h2: 16px;
  --fs-h3: 14px;
  --fs-body: 14px;
  --fs-small: 12px;

  /* è¡Œé«˜ */
  --lh: 1.55;
}

body{
  font-family: var(--font);
  line-height: var(--lh);
}

/* å¸¸è§æ§ä»¶ä¹Ÿå¼ºåˆ¶åŒä¸€å­—ä½“ï¼ˆé¿å…æ··è¿›å®‹ä½“ï¼‰ */
button, input, select, textarea, table{
  font-family: var(--font);
}

/* æ ‡é¢˜/åˆ†åŒºå­—å·å±‚çº§ */
.title{               /* ä½ çš„ h2.title */
  font-size: var(--fs-h1);
  font-weight: 700;
  letter-spacing: .2px;
}

.card h3{
  font-size: var(--fs-h2);
  font-weight: 700;
}

label, .muted, .help, .hint{
  font-size: var(--fs-small);
  color: var(--muted);
}

/* è¡¨æ ¼å­—å·ç¨å°ä¸€ç‚¹æ›´â€œé‡‘èæŠ¥è¡¨â€ */
table{
  font-size: var(--fs-h3);
}
th{
  font-weight: 650;
}

/* ====== B) é¡¶éƒ¨æ ï¼šå·¦å¯¹é½æ ‡é¢˜ã€å³å¯¹é½ metaï¼Œå¹¶ä¸”å¯¹é½åˆ°å†…å®¹åŒºè¾¹ç•Œ ====== */
/* å…³é”®ï¼šç”¨ padding: calc((100vw - 1220px)/2) è®© topbar å†…å®¹ä¸ container åŒä¸€â€œå·¦è¾¹çº¿â€ */
.topbar{
  /* ä½ çš„è“è‰²å¯ä¿ç•™ï¼šè¿™é‡Œåªåšå¸ƒå±€ä¸å¯¹é½ */
  display: flex;
  align-items: center;
  gap: 16px;

  /* è®©é¡¶éƒ¨æ çš„å†…å®¹å·¦å³è¾¹ç•Œ = container çš„å·¦å³è¾¹ç•Œ */
  padding-left: max(24px, calc((100vw - 1220px)/2));
  padding-right: max(24px, calc((100vw - 1220px)/2));
  padding-top: 14px;
  padding-bottom: 14px;
}

/* ä½  topbar é‡Œæœ‰ä¸¤ä¸ªç©º divï¼šç›´æ¥éšè—ï¼Œé¿å…å½±å“å¸ƒå±€ */
.topbar > div:first-child,
.topbar > div:last-child{
  display: none;
}

/* è®©æ ‡é¢˜åœ¨å·¦è¾¹ï¼ˆå¹¶ä¸”â€œé‡â€å­—ä¸å·¦ä¾§å¤§å¡ç‰‡è¾¹ç•Œå¯¹é½ï¼‰ */
.topbar .title{
  margin: 0;          /* å»æ‰ h2 é»˜è®¤ margin */
  order: 1;
  text-align: left;
}

/* è®© meta è·‘åˆ°æœ€å³è¾¹ï¼Œå¹¶ä¸”ä¸å³ä¾§å¤§æ¡†å³è¾¹çº¿å¯¹é½ */
.topbar .meta{
  order: 2;
  margin-left: auto;
  text-align: right;
  font-size: var(--fs-small);
  color: rgba(255,255,255,.86); /* é¡¶éƒ¨æ æ˜¯è“çš„ï¼Œå­—è¦æ›´å¹²å‡€ */
  line-height: 1.35;
}

/* å¦‚æœä½ çš„ topbar èƒŒæ™¯æ˜¯æ·±è“ï¼Œæ ‡é¢˜ä¹Ÿæ”¹æˆæµ…è‰²æ›´åƒ Sora å›¾ */
.topbar .title{
  color: rgba(255,255,255,.95);
}
</style>

</head>

<body>
  <div class="topbar">
    <div></div>
    <div class="meta">
      å¼€å‘å•ä½ï¼šç›ˆé€šæ™ºè”<br/>
      ç‰ˆæœ¬å·ï¼šV1.0
    </div>
    <h2 class="title">é‡å¡å……ç”µç«™æŠ•èµ„è¾…åŠ©å†³ç­–ç³»ç»Ÿ</h2>
    <div></div>
  </div>

  <div class="container">
    <div class="grid">


  <div class="card">
    <h3>è¾“å…¥å‚æ•°</h3>
    <div class="row">
  <div style="flex:1; min-width:260px;">
    <label>åœºç«™ä½ç½®</label>
    <input id="loc" type="text" value="" placeholder="ä¾‹å¦‚ï¼šä½›å±±é¡ºå¾· / å¹¿å·ç™½äº‘ / æ·±åœ³é¾™å²—">
  </div>
</div>



    <div class="row">
      <div>
        <label>åœºåœ°é•¿åº¦ (m)</label>
        <input id="len" type="number" value="36" step="0.1">
      </div>
      <div>
        <label>åœºåœ°å®½åº¦ (m)</label>
        <input id="wid" type="number" value="32" step="0.1">
      </div>
      
    </div>

    <details class="card" style="margin-top:12px;">
      <summary style="cursor:pointer; font-weight:bold;">é«˜çº§å‚æ•°è®¾ç½®ï¼ˆå¯é€‰ï¼‰</summary>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>å•æªæ—¥å……ç”µé‡ (kWh/å¤©)</label>
          <input id="kwh" type="number" value="1000" step="10">
        </div>
        <div>
          <label>æœåŠ¡è´¹ (å…ƒ/åº¦)</label>
          <input id="fee" type="number" value="0.3" step="0.01">
        </div>
        <div>
          <label>å¹´è¿è¥å¤©æ•° (å¤©)</label>
          <input id="days" type="number" value="330" step="1">
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>ç”µåŠ›æŠ•èµ„å•ä»· (å…ƒ/kVA)</label>
          <input id="powerCost" type="number" value="600" step="10">
        </div>
        <div>
          <label>åœŸå»ºå•ä»· (å…ƒ/ã¡)</label>
          <input id="civilCost" type="number" value="200" step="10">
        </div>
        <div>
          <label>å•æ¡©æˆæœ¬ (å…ƒ/å°)</label>
          <input id="pileCost" type="number" value="45000" step="500">
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>åœºåœ°ç§Ÿé‡‘ (å…ƒ/ã¡Â·æœˆ)</label>
          <input id="rent" type="number" value="0" step="1">
        </div>
        <div>
          <label>çœ‹å®ˆäººæ•° (äºº)</label>
          <input id="staff" type="number" value="0" step="1">
        </div>
        <div>
          <label>äººå‡å·¥èµ„ (å…ƒ/æœˆÂ·äºº)</label>
          <input id="salary" type="number" value="0" step="100">
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>æ¯æ¡©æŠ˜ç®—å®¹é‡ (kVA/æ¡©)</label>
          <input id="pileKva" type="number" value="400" step="10">
        </div>
        <div>
          <label>æ¯æ¡©æªæ•° (æª/æ¡©)</label>
          <input id="guns" type="number" value="2" step="1">
        </div>        
      </div>

      <div style="margin-top:12px;">
        <button id="btnReset" type="button">æ¢å¤é»˜è®¤å£å¾„</button>
      </div>
    </details>

    <div style="margin-top:16px;">
  <button id="btnCalc" type="button" class="btn-primary">ç”Ÿæˆæ–¹æ¡ˆ</button>
  <button id="btnWord" type="button" class="btn-ghost">å¯¼å‡ºåˆæ­¥è®¾è®¡æ–¹æ¡ˆ</button>
  <button id="btnSens" type="button" class="btn-ghost">æ•æ„Ÿæ€§åˆ†æ</button>
    </div>

  </div>

  <div class="card">
    <h3>æŠ•èµ„è¯„ä¼°</h3>
        <div class="kpis">
      <div class="kpi">
        <div class="k">æ¨èé…ç½®</div>
        <div class="v" id="kpiConfig">â€”</div>
        <div class="s" id="kpiStalls">è½¦ä½ï¼šâ€”</div>
        <div class="s" id="kpiPower">ç”µåŠ›å®¹é‡ï¼šâ€”</div>
      </div>
      <div class="kpi">
        <div class="k">é¢„è®¡æ€»æŠ•èµ„</div>
        <div class="v" id="kpiInvest">â€”</div>
        <div class="s">æŠ•èµ„ï¼ˆç”µåŠ›+åœŸå»º+è®¾å¤‡ï¼‰</div>
      </div>
      <div class="kpi">
        <div class="k">å¹´æ”¶å…¥ï¼ˆæœåŠ¡è´¹ï¼‰</div>
        <div class="v" id="kpiRevenue">â€”</div>
        <div class="s">æŒ‰æœåŠ¡è´¹å£å¾„</div>
      </div>
      <div class="kpi">
        <div class="k">å‡€æ”¶å…¥</div>
        <div class="v" id="kpiNet">â€”</div>
        <div class="s">
          å›æ”¶æœŸï¼š<span id="kpiPayback">â€”</span>
          <span id="kpiBadge" class="badge">â€”</span>
        </div>
      </div>
    </div>

    <hr style="margin:8px 0 16px; border:none; border-top:1px solid #eee;">

<h3>æ•æ„Ÿæ€§åˆ†æ</h3>
<div id="sensSummary" class="muted">å°šæœªè¿è¡Œæ•æ„Ÿæ€§åˆ†æ</div>

<div style="overflow:auto; margin-top:10px;">
  <table id="sensTable" border="1" cellspacing="0" cellpadding="6"
    style="border-collapse:collapse; width:100%; min-width:860px;">
    <thead>
      <tr>
        <th>åºå·</th>
        <th>åˆ©ç”¨ç‡(kWh/æªÂ·å¤©)</th>
        <th>æœåŠ¡è´¹(å…ƒ/åº¦)</th>
        <th>ç§Ÿé‡‘(å…ƒ/ã¡Â·æœˆ)</th>
        <th>å‡€å¹´ç°é‡‘æµ(ä¸‡å…ƒ/å¹´)</th>
        <th>å‡€å›æ”¶æœŸ(å¹´)</th>
        <th>çŠ¶æ€</th>
      </tr>
    </thead>
    <tbody id="sensBody">
      <tr><td colspan="7" class="muted">ï¼ˆç­‰å¾…è¿è¡Œï¼‰</td></tr>
    </tbody>
  </table>
</div>

<hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

<h3>è¯¦ç»†æµ‹ç®—</h3>
<pre id="out" class="muted" style="background:#fff; color:var(--text); border:1px solid var(--border);"></pre>
<div id="layout"></div>

</div>



  </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function money(x) { return (Math.round(x)).toLocaleString('zh-CN') + " å…ƒ"; }
  function num(x) { return (Math.round(x * 100) / 100).toLocaleString('zh-CN'); }

  function resetDefaults() {
    if ($('loc')) $('loc').value = "";
    $('kwh').value = 1000;
    $('fee').value = 0.3;
    $('days').value = 330;
    $('powerCost').value = 600;
    $('civilCost').value = 200;
    $('pileCost').value = 45000;
    $('pileKva').value = 400;
    $('guns').value = 2;   
    $('rent').value = 0;
    $('staff').value = 0;
    $('salary').value = 0;
  }

  function buildPayload() {
    const payload = {
      site_location: String($('loc')?.value || "").trim(),
      site_length_m: parseFloat($('len').value),
      site_width_m: parseFloat($('wid').value),
      
      pile_kva_per: parseFloat($('pileKva').value),
      guns_per_pile: parseInt($('guns').value, 10),

      kwh_per_gun_per_day: parseFloat($('kwh').value),
      service_fee_yuan_per_kwh: parseFloat($('fee').value),
      days_per_year: parseInt($('days').value, 10),

      power_cost_yuan_per_kva: parseFloat($('powerCost').value),
      civil_cost_yuan_per_sqm: parseFloat($('civilCost').value),
      pile_cost_yuan_each: parseFloat($('pileCost').value),

      
      rent_yuan_per_sqm_month: parseFloat($('rent').value),
      staff_count: parseInt($('staff').value, 10),
      salary_yuan_per_month: parseFloat($('salary').value),
    };
    console.log("DEBUG payload:", payload);
    return payload;
  }


    function safeNum(x) {
    const v = Number(x);
    return Number.isFinite(v) ? v : null;
  }

  async function postCalc(payload) {
    const res = await fetch('/api/calculate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t);
    }
    return await res.json();
  }


  async function runCalc() {
    try {
      const payload = buildPayload();
      const res = await fetch('/api/calculate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const t = await res.text();
        $('out').innerText = "è®¡ç®—å¤±è´¥ï¼š" + t;
        $('layout').innerHTML = "";
        return;
      }

      const d = await res.json();

      const investWan = (d.invest_total_yuan / 10000).toFixed(1);
      const revenueWan = (d.revenue_year_yuan / 10000).toFixed(1);
      const revenueNetWan = (d.revenue_net_year_yuan / 10000).toFixed(1);

      const payback = d.payback_years ? d.payback_years.toFixed(1) : "N/A";
      const paybackNet = d.payback_net_years ? d.payback_net_years.toFixed(1) : "N/A";

            // ===== é”€å”®æ‘˜è¦å››å®«æ ¼ KPI =====
      $('kpiConfig').innerText = `${d.n_recommend ?? 'â€”'} å° 400kW ä¸€æœºåŒæª`;
      $('kpiStalls').innerText = `è½¦ä½ï¼š${d.stalls ?? 'â€”'}ï¼ˆ1æ¡©2è½¦ä½ï¼‰`;
      const n = Number(d.n_recommend ?? 0);
      const powerKva = n * 400;
      $('kpiPower').innerText = `ç”µåŠ›å®¹é‡ï¼š${powerKva.toLocaleString('zh-CN')} kVA`;
      $('kpiInvest').innerText = `${investWan} ä¸‡`;
      $('kpiRevenue').innerText = `${revenueWan} ä¸‡/å¹´`;
      $('kpiNet').innerText = `${revenueNetWan} ä¸‡/å¹´`;
      $('kpiPayback').innerText = `${paybackNet} å¹´`;

      // å¾½æ ‡ï¼šğŸŸ¢ğŸŸ¡ğŸ”´
      let badge = $('kpiBadge');
      badge.className = "badge";
      if (paybackNet === "N/A") {
        badge.innerText = "N/A";
      } else {
        const pb = parseFloat(paybackNet);
        if (!Number.isFinite(pb)) badge.innerText = "N/A";
        else if (pb <= 2) { badge.innerText = "ğŸŸ¢ ä¼˜ç§€"; badge.classList.add('ok'); }
        else if (pb <= 3) { badge.innerText = "ğŸŸ¡ å¯æ¥å—"; badge.classList.add('warn'); }
        else { badge.innerText = "ğŸ”´ åå¼±"; badge.classList.add('bad'); }
      }


      let summary = `
ã€åœºç«™å»ºè®¾åˆè®¾å»ºè®®å’Œå›æŠ¥è¯„ä¼°ã€‘

å……ç”µè®¾å¤‡é…ç½®ï¼š${d.n_recommend} å° 400kW ä¸€æœºåŒæªå……ç”µæ¡©
é¢„è®¡æ€»æŠ•èµ„ï¼š${investWan} ä¸‡å…ƒ
é¢„è®¡å¹´æ”¶å…¥ï¼ˆæœåŠ¡è´¹å£å¾„ï¼‰ï¼š${revenueWan} ä¸‡å…ƒ
é¢„è®¡å‡€å¹´ç°é‡‘æµï¼ˆæ‰£ç§Ÿé‡‘/äººå·¥ï¼‰ï¼š${revenueNetWan} ä¸‡å…ƒ
é¢„è®¡å›æŠ¥å‘¨æœŸï¼ˆå‡€æ”¶å…¥ï¼‰ï¼š${paybackNet} å¹´
`;

      const lines = [];
      lines.push(`æ¨èæ¡©æ•° N = ${d.n_recommend}ï¼ˆç”µåŠ›çº¦æŸ n_power=${d.n_power}ï¼›é¢ç§¯çº¦æŸ n_area=${d.n_area}ï¼‰`);
      lines.push(`è½¦ä½æ•° = ${d.stalls}ï¼ˆ1æ¡©æœåŠ¡2è½¦ä½ï¼‰`);
      lines.push(`åœºåœ°é¢ç§¯ = ${num(d.site_area_sqm)} ã¡ï¼›æ¨¡å—å ç”¨é¢ç§¯ = ${num(d.used_area_sqm)} ã¡`);
      lines.push(`æŠ•èµ„ï¼šç”µåŠ› ${money(d.invest_power_yuan)}ï¼›åœŸå»º ${money(d.invest_civil_yuan)}ï¼›è®¾å¤‡ ${money(d.invest_pile_yuan)}ï¼›åˆè®¡ ${money(d.invest_total_yuan)}`);
      lines.push(`å¹´å……ç”µé‡ = ${num(d.energy_year_kwh)} kWhï¼›å¹´æ”¶å…¥ï¼ˆæŒ‰æœåŠ¡è´¹å£å¾„ï¼‰= ${money(d.revenue_year_yuan)}`);
      lines.push(`å¹´ç§Ÿé‡‘ = ${money(d.rent_year_yuan)}ï¼›å¹´äººå·¥ = ${money(d.labor_year_yuan)}`);
      lines.push(`å‡€å¹´ç°é‡‘æµ = ${money(d.revenue_net_year_yuan)}ï¼›å‡€å›æ”¶æœŸ = ${paybackNet} å¹´`);

      if (d.notes && d.notes.length) {
        lines.push("é£é™©/æç¤ºï¼š");
        d.notes.forEach(x => lines.push(" - " + x));
      }

      const remark = "å¤‡æ³¨ï¼šå¦‚éœ€è¯¦ç»†çš„åœºç«™è®¾è®¡æ–¹æ¡ˆï¼ˆCADè®¾è®¡å›¾ï¼‰ã€äº§å“é…ç½®æ–¹æ¡ˆåŠå‚æ•°ã€è¯·è‡´ç”µ1*********ã€‚";

        $('out').innerText = summary + "\n\n" + lines.join("\n") + "\n" + remark;
        renderLayoutSVG(d);

    } catch (e) {
      console.error(e);
      $('out').innerText = "å‰ç«¯å¼‚å¸¸ï¼š" + (e?.message || e);
      $('layout').innerHTML = "";
    }
  }

  function renderLayoutSVG(data) {
    const container = $('layout');
    const rowCount = Number(data.row_count || 0);
    const stallsRaw = Number(data.stalls_per_row_raw || 0);
    const stallsDraw = Number(data.stalls_per_row_draw || 0);

    if (!rowCount || !stallsDraw) {
      container.innerHTML = '<div class="layout-empty">å½“å‰å‚æ•°ä¸‹æ— æ³•ç”Ÿæˆç®€æ˜“å¸ƒå±€å›¾ã€‚</div>';
      return;
    }

    const stallW = 28;
    const stallH = 34;
    const gap = 4;
    const margin = 16;

    if (rowCount === 1) {
      const left = Number(data.stalls_left || 0);
      const right = Number(data.stalls_right || 0);

      if (left + right !== stallsDraw || left < 0 || right < 0) {
        container.innerHTML = '<div class="layout-empty">å•æ’æ‹†åˆ†æ•°æ®å¼‚å¸¸ï¼Œæ— æ³•ç»˜å›¾ã€‚</div>';
        return;
      }

      const transformerW = 72;
      const centerGap = 20;
      const totalW = margin * 2 + left * (stallW + gap) + right * (stallW + gap) + transformerW + centerGap * 2;
      const totalH = margin * 2 + stallH + 36;
      let shapes = [];

      const leftStartX = margin;
      for (let i = 0; i < left; i++) {
        const x = leftStartX + i * (stallW + gap);
        shapes.push(`<rect x="${x}" y="${margin + 28}" width="${stallW}" height="${stallH}" fill="#dbeafe" stroke="#1e40af"/>`);
      }

      const tfX = leftStartX + left * (stallW + gap) + centerGap;
      shapes.push(`<rect x="${tfX}" y="${margin + 22}" width="${transformerW}" height="${stallH + 12}" fill="#fde68a" stroke="#92400e"/>`);
      shapes.push(`<text x="${tfX + transformerW / 2}" y="${margin + 47}" text-anchor="middle" font-size="12">å˜å‹å™¨</text>`);

      const rightStartX = tfX + transformerW + centerGap;
      for (let i = 0; i < right; i++) {
        const x = rightStartX + i * (stallW + gap);
        shapes.push(`<rect x="${x}" y="${margin + 28}" width="${stallW}" height="${stallH}" fill="#dbeafe" stroke="#1e40af"/>`);
      }

      for (let i = 0; i < Math.floor(left / 2); i++) {
        const x = leftStartX + i * 2 * (stallW + gap) + stallW - 4;
        shapes.push(`<rect x="${x}" y="${margin + 8}" width="8" height="12" fill="#dc2626"/>`);
      }
      for (let i = 0; i < Math.floor(right / 2); i++) {
        const x = rightStartX + i * 2 * (stallW + gap) + stallW - 4;
        shapes.push(`<rect x="${x}" y="${margin + 8}" width="8" height="12" fill="#dc2626"/>`);
      }

      container.innerHTML = `<svg viewBox="0 0 ${totalW} ${totalH}" width="100%" height="${totalH}" xmlns="http://www.w3.org/2000/svg">
        <text x="${margin}" y="14" font-size="12" fill="#334155">å•æ’ç®€æ˜“å¸ƒå±€ï¼ˆå·¦${left} + å³${right}ï¼‰</text>
        ${shapes.join('')}
      </svg>`;
      return;
    }

    const rowStalls = stallsRaw > 0 ? stallsRaw : stallsDraw;
    const moduleH = stallH * 2 + 34;
    const totalW = margin * 2 + rowStalls * (stallW + gap);
    const totalH = margin * 2 + Math.ceil(rowCount / 2) * moduleH;
    let shapes = [];

    function drawRow(y, rowIdx) {
      for (let i = 0; i < rowStalls; i++) {
        const x = margin + i * (stallW + gap);
        shapes.push(`<rect x="${x}" y="${y}" width="${stallW}" height="${stallH}" fill="#e2e8f0" stroke="#334155"/>`);
      }
      for (let p = 0; p < Math.floor(rowStalls / 2); p++) {
        const x = margin + p * 2 * (stallW + gap) + stallW - 4;
        shapes.push(`<rect x="${x}" y="${y - 14}" width="8" height="12" fill="#dc2626"/>`);
      }
      shapes.push(`<text x="${margin}" y="${y + stallH + 14}" font-size="11" fill="#475569">ç¬¬${rowIdx + 1}æ’</text>`);
    }

    for (let m = 0; m < Math.ceil(rowCount / 2); m++) {
      const topY = margin + m * moduleH;
      const firstRow = m * 2;
      drawRow(topY, firstRow);
      if (firstRow + 1 < rowCount) {
        drawRow(topY + stallH + 18, firstRow + 1);
      }
    }

    container.innerHTML = `<svg viewBox="0 0 ${totalW} ${totalH}" width="100%" height="${totalH}" xmlns="http://www.w3.org/2000/svg">
      <text x="${margin}" y="14" font-size="12" fill="#334155">å¤šæ’ç®€æ˜“å¸ƒå±€ï¼ˆå…±${rowCount}æ’ï¼‰</text>
      ${shapes.join('')}
    </svg>`;
  }

  function renderLayoutSVG(data) {
    const container = $('layout');
    const rowCount = Number(data.row_count || 0);
    const stallsDraw = Number(data.stalls_per_row_draw || 0);

    if (!rowCount || !stallsDraw) {
      container.innerHTML = '<div class="layout-empty">å½“å‰å‚æ•°ä¸‹æ— æ³•ç”Ÿæˆç®€æ˜“å¸ƒå±€å›¾ã€‚</div>';
      return;
    }

    const STALL_WIDTH_M = 6;
    const STALL_LEN_M = 15;
    const scale = 5;
    const stallW = STALL_WIDTH_M * scale;
    const stallL = STALL_LEN_M * scale;
    const lane = stallL;

    const margin = 20;
    const pileW = Math.max(8, Math.round(stallW * 0.16));
    const pileH = Math.max(14, Math.round(stallL * 0.2));
    const txW = Math.max(58, Math.round(stallW * 1.6));
    const txH = Math.max(22, Math.round(stallL * 0.34));

    const drawStalls = (shapes, y, stallsCount, fill, stroke) => {
      for (let i = 0; i < stallsCount; i++) {
        const x = margin + i * stallW;
        shapes.push(`<rect x="${x}" y="${y}" width="${stallW}" height="${stallL}" fill="${fill}" stroke="${stroke}"/>`);
      }
    };

    const drawTransformer = (shapes, y) => {
      const txX = margin + (stallsDraw * stallW) / 2 - txW / 2;
      const txY = y + stallL / 2 - txH / 2;
      shapes.push(`<rect x="${txX}" y="${txY}" width="${txW}" height="${txH}" fill="#fde68a" stroke="#92400e"/>`);
      shapes.push(`<text x="${txX + txW / 2}" y="${txY + txH / 2 + 4}" text-anchor="middle" font-size="12">å˜å‹å™¨</text>`);
    };

    const drawPilesBy2Stalls = (shapes, yTop) => {
      const pileCount = Math.floor(stallsDraw / 2);
      for (let p = 0; p < pileCount; p++) {
        const xMid = margin + (p * 2 + 1) * stallW;
        shapes.push(`<rect x="${xMid - pileW / 2}" y="${yTop}" width="${pileW}" height="${pileH}" fill="#dc2626"/>`);
      }
    };

    // å•æ’ï¼šæŒ‰åç«¯æ‹†åˆ†ç»“æœç»˜åˆ¶å·¦å³ + ä¸­é—´å˜å‹å™¨
    if (rowCount === 1) {
      const left = Number(data.stalls_left || 0);
      const right = Number(data.stalls_right || 0);
      if (left + right !== stallsDraw || left < 0 || right < 0) {
        container.innerHTML = '<div class="layout-empty">å•æ’æ‹†åˆ†æ•°æ®å¼‚å¸¸ï¼Œæ— æ³•ç»˜å›¾ã€‚</div>';
        return;
      }

      const topY = margin + pileH + 12;
      const totalW = margin * 2 + stallsDraw * stallW;
      const totalH = topY + stallL + margin;
      const shapes = [];

      // å·¦å³ä¸¤ä¾§è½¦ä½ï¼ˆä¿æŒåç«¯æ‹†åˆ†å£å¾„ï¼‰
      for (let i = 0; i < left; i++) {
        const x = margin + i * stallW;
        shapes.push(`<rect x="${x}" y="${topY}" width="${stallW}" height="${stallL}" fill="#dbeafe" stroke="#1e40af"/>`);
      }
      for (let i = 0; i < right; i++) {
        const x = margin + (left + i) * stallW;
        shapes.push(`<rect x="${x}" y="${topY}" width="${stallW}" height="${stallL}" fill="#dbeafe" stroke="#1e40af"/>`);
      }

      // å•æ’æ¡©ï¼šæ¯2è½¦ä½ä¸€æ¡©ï¼Œä½äºè½¦ä½å‰æ–¹ï¼ˆé ç”µç¼†æ²Ÿï¼‰
      drawPilesBy2Stalls(shapes, margin + 4);

      // å˜å‹å™¨ä½äºå·¦å³ä¸­é—´
      const txX = margin + left * stallW - txW / 2;
      const txY = topY + stallL / 2 - txH / 2;
      shapes.push(`<rect x="${txX}" y="${txY}" width="${txW}" height="${txH}" fill="#fde68a" stroke="#92400e"/>`);
      shapes.push(`<text x="${txX + txW / 2}" y="${txY + txH / 2 + 4}" text-anchor="middle" font-size="12">å˜å‹å™¨</text>`);

      container.innerHTML = `<svg viewBox="0 0 ${totalW} ${totalH}" width="100%" height="${totalH}" xmlns="http://www.w3.org/2000/svg">
        <text x="${margin}" y="14" font-size="12" fill="#334155">å•æ’ç®€æ˜“å¸ƒå±€ï¼ˆå·¦${left}+å³${right}ï¼›é€šé“=è½¦ä½é•¿åº¦ï¼‰</text>
        ${shapes.join('')}
      </svg>`;
      return;
    }

    // å¤šæ’ï¼š2æ’ä¸€ä¸ªèƒŒé èƒŒæ¨¡å—ï¼›æ¨¡å—é—´ç•™ laneï¼›å¥‡æ•°æœ€åä¸€æ’å•æ’æ¨¡å—
    const modulePairH = stallL + lane + stallL;
    const moduleSingleH = stallL;
    const moduleGap = lane;

    const fullPairs = Math.floor(rowCount / 2);
    const hasLastSingle = rowCount % 2 === 1;
    const totalModulesHeight = fullPairs * modulePairH + (hasLastSingle ? moduleSingleH : 0) + Math.max(0, fullPairs + (hasLastSingle ? 1 : 0) - 1) * moduleGap;

    const totalW = margin * 2 + stallsDraw * stallW;
    const totalH = margin * 2 + totalModulesHeight;
    const shapes = [];

    let cursorY = margin;
    let rowIdx = 0;

    for (let m = 0; m < fullPairs; m++) {
      const topRowY = cursorY;
      const laneY = topRowY + stallL;
      const bottomRowY = laneY + lane;

      // ä¸Šä¸‹æ’è½¦ä½
      drawStalls(shapes, topRowY, stallsDraw, '#e2e8f0', '#334155');
      drawStalls(shapes, bottomRowY, stallsDraw, '#e2e8f0', '#334155');

      // ä¸­é—´é€šé“
      shapes.push(`<rect x="${margin}" y="${laneY}" width="${stallsDraw * stallW}" height="${lane}" fill="#f8fafc" stroke="#cbd5e1"/>`);

      // èƒŒé èƒŒæ¡©ï¼šæ¯2è½¦ä½å®½ä¸€å°ï¼Œå¸ƒç½®åœ¨ä¸­é—´é€šé“é ä¸­çº¿
      const pileCount = Math.floor(stallsDraw / 2);
      for (let p = 0; p < pileCount; p++) {
        const xMid = margin + (p * 2 + 1) * stallW;
        const yMid = laneY + lane / 2 - pileH / 2;
        shapes.push(`<rect x="${xMid - pileW / 2}" y="${yMid}" width="${pileW}" height="${pileH}" fill="#dc2626"/>`);
      }

      // æ¯æ’éƒ½æ˜¾ç¤ºå˜å‹å™¨ï¼ˆxä¸€è‡´ï¼‰
      drawTransformer(shapes, topRowY);
      drawTransformer(shapes, bottomRowY);

      shapes.push(`<text x="${margin}" y="${topRowY - 4}" font-size="11" fill="#475569">ç¬¬${rowIdx + 1}æ’</text>`);
      shapes.push(`<text x="${margin}" y="${bottomRowY - 4}" font-size="11" fill="#475569">ç¬¬${rowIdx + 2}æ’</text>`);

      rowIdx += 2;
      cursorY += modulePairH + moduleGap;
    }

    if (hasLastSingle) {
      const y = cursorY;
      drawStalls(shapes, y, stallsDraw, '#e2e8f0', '#334155');
      drawPilesBy2Stalls(shapes, y - pileH - 4);
      drawTransformer(shapes, y);
      shapes.push(`<text x="${margin}" y="${y - 4}" font-size="11" fill="#475569">ç¬¬${rowIdx + 1}æ’</text>`);
    }

    container.innerHTML = `<svg viewBox="0 0 ${totalW} ${totalH}" width="100%" height="${totalH}" xmlns="http://www.w3.org/2000/svg">
      <text x="${margin}" y="14" font-size="12" fill="#334155">å¤šæ’ç®€æ˜“å¸ƒå±€ï¼ˆèƒŒé èƒŒæ¨¡å—+æ¨¡å—é—´é€šé“ï¼Œé€šé“=è½¦ä½é•¿åº¦ï¼‰</text>
      ${shapes.join('')}
    </svg>`;
  }


  async function exportWord() {
    try {
      const payload = buildPayload();

      const res = await fetch('/api/report_word', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const t = await res.text();
        alert("å¯¼å‡ºå¤±è´¥ï¼š" + t);
        return;
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "é‡å¡å……ç”µç«™åˆæ­¥è®¾è®¡æ–¹æ¡ˆ.docx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e) {
      alert("å¯¼å‡ºå¼‚å¸¸ï¼š" + e.message);
    }
  }


  async function runSensitivity() {
    // 1) å–å½“å‰è¾“å…¥ä½œä¸ºâ€œåŸºå‡†â€
    const base = buildPayload();

    const baseKwh = base.kwh_per_gun_per_day;
    const baseFee = base.service_fee_yuan_per_kwh;
    const baseRent = base.rent_yuan_per_sqm_month;

    // 2) ä¸‰æ¡£è®¾ç½®ï¼šAåˆ©ç”¨ç‡ Ã— BæœåŠ¡è´¹ Ã— Cç§Ÿé‡‘ï¼ˆ27ç»„ï¼‰
    const kwhLevels = [
      Math.round(baseKwh * 0.6),
      Math.round(baseKwh * 1.0),
      Math.round(baseKwh * 1.2),
    ];

    const feeLevels = [
      Math.round(baseFee * 0.8 * 100) / 100,
      Math.round(baseFee * 1.0 * 100) / 100,
      Math.round(baseFee * 1.2 * 100) / 100,
    ];

    const rentLevels = [
      0,
      Math.round(baseRent * 1.0),
      Math.round(baseRent * 1.5),
    ];

    // UI åˆå§‹åŒ–
    $('sensSummary').innerText = "æ­£åœ¨è®¡ç®— 27 ç»„æƒ…æ™¯ï¼ˆåˆ©ç”¨ç‡Ã—æœåŠ¡è´¹Ã—ç§Ÿé‡‘ï¼‰...";
    $('sensBody').innerHTML = `<tr><td colspan="7" class="muted">è®¡ç®—ä¸­...</td></tr>`;

    const rows = [];
    let idx = 0;

    try {
      for (const kwh of kwhLevels) {
        for (const fee of feeLevels) {
          for (const rent of rentLevels) {
            idx += 1;

            const p = { ...base };
            p.kwh_per_gun_per_day = kwh;
            p.service_fee_yuan_per_kwh = fee;
            p.rent_yuan_per_sqm_month = rent;

            const r = await postCalc(p);

            const net = safeNum(r.revenue_net_year_yuan);
            const netWan = net === null ? null : (net / 10000);

            const pb = safeNum(r.payback_net_years);

            // çŠ¶æ€è§„åˆ™ï¼šå‡€<=0 ç›´æ¥çº¢ï¼›å¦åˆ™æŒ‰å›æ”¶æœŸé˜ˆå€¼åˆ†è‰²
            let status = "ğŸŸ¢";
            if (net === null || net <= 0) status = "ğŸ”´";
            else if (pb !== null && pb > 3) status = "ğŸ”´";
            else if (pb !== null && pb > 2) status = "ğŸŸ¡";

            rows.push({ idx, kwh, fee, rent, netWan, pb, status });
          }
        }
      }

      // 3) æ¸²æŸ“è¡¨æ ¼
      $('sensBody').innerHTML = rows.map(x => {
        const netText = x.netWan === null ? "N/A" : x.netWan.toFixed(1);
        const pbText = x.pb === null ? "N/A" : x.pb.toFixed(1);
        return `
          <tr>
            <td>${x.idx}</td>
            <td>${x.kwh}</td>
            <td>${x.fee}</td>
            <td>${x.rent}</td>
            <td>${netText}</td>
            <td>${pbText}</td>
            <td>${x.status}</td>
          </tr>
        `;
      }).join("");

      // 4) äºŒçº§è§†å›¾ï¼ˆé”€å”®æ€»ç»“ï¼‰ï¼šåŸºå‡†/æœ€å¥½/æœ€å·® + æœ€æ•æ„Ÿå› å­
      const baseline = rows.find(x => x.kwh === kwhLevels[1] && x.fee === feeLevels[1] && x.rent === rentLevels[1]);

      // æœ€å¥½/æœ€å·®ï¼ˆæŒ‰å‡€å›æ”¶æœŸpbæ’åºï¼Œçº¢è‰²/ç©ºè§†ä¸ºæœ€å·®ï¼‰
      const score = (x) => (x.pb === null || x.status === "ğŸ”´") ? 1e9 : x.pb;
      const sorted = [...rows].sort((a, b) => score(a) - score(b));
      const best = sorted[0];
      const worst = sorted[sorted.length - 1];

      // å•å˜é‡æ‰«æï¼šå…¶å®ƒå›ºå®šåœ¨ä¸­æ¡£ï¼Œæ¯”è¾ƒå›æ”¶æœŸè·¨åº¦ï¼ˆè¶Šå¤§è¶Šæ•æ„Ÿï¼‰
      function scan(filterFn) {
        return rows.filter(filterFn).map(x => score(x)).filter(v => v < 1e8);
      }
      function range(vals) {
        if (!vals.length) return null;
        return Math.max(...vals) - Math.min(...vals);
      }

      const rKwh = range(scan(x => x.fee === feeLevels[1] && x.rent === rentLevels[1]));
      const rFee = range(scan(x => x.kwh === kwhLevels[1] && x.rent === rentLevels[1]));
      const rRent = range(scan(x => x.kwh === kwhLevels[1] && x.fee === feeLevels[1]));

      const sensArr = [
        { name: "åˆ©ç”¨ç‡", delta: rKwh },
        { name: "æœåŠ¡è´¹", delta: rFee },
        { name: "ç§Ÿé‡‘", delta: rRent },
      ].sort((a, b) => (b.delta ?? -1) - (a.delta ?? -1));

      const sensText = sensArr[0].delta === null
        ? "æœ€æ•æ„Ÿå› å­ï¼šæ— æ³•è®¡ç®—ï¼ˆå¯èƒ½ä¸­æ¡£å·²å‡ºç°å‡€ç°é‡‘æµ<=0ï¼‰"
        : `æœ€æ•æ„Ÿå› å­ï¼š${sensArr[0].name}ï¼ˆå‡€å›æ”¶æœŸè·¨åº¦â‰ˆ${sensArr[0].delta.toFixed(1)}å¹´ï¼‰`;

      function fmt(x) {
        if (!x) return "N/A";
        const net = x.netWan === null ? "N/A" : (x.netWan.toFixed(1) + "ä¸‡/å¹´");
        const pb = x.pb === null ? "N/A" : (x.pb.toFixed(1) + "å¹´");
        return `kWh=${x.kwh}, fee=${x.fee}, rent=${x.rent} â†’ å‡€ç°é‡‘æµ${net}ï¼Œå‡€å›æ”¶æœŸ${pb}ï¼Œ${x.status}`;
      }

      $('sensSummary').innerText =
`ã€æ•æ„Ÿæ€§åˆ†ææ€»ç»“ã€‘
- åŸºå‡†æƒ…æ™¯ï¼š${fmt(baseline)}
- æœ€ä½³æƒ…æ™¯ï¼š${fmt(best)}
- æœ€å·®æƒ…æ™¯ï¼š${fmt(worst)}
- ${sensText}
ï¼ˆçŠ¶æ€è§„åˆ™ï¼šğŸ”´=å‡€ç°é‡‘æµ<=0 æˆ– å›æ”¶æœŸ>3å¹´ï¼›ğŸŸ¡=2~3å¹´ï¼›ğŸŸ¢=<=2å¹´ï¼‰`;

    } catch (e) {
      console.error(e);
      $('sensSummary').innerText = "æ•æ„Ÿæ€§åˆ†æå¤±è´¥ï¼š" + (e?.message || e);
      $('sensBody').innerHTML = `<tr><td colspan="7" class="muted">å¤±è´¥ï¼šè¯·æ‰“å¼€ F12 Console æŸ¥çœ‹é”™è¯¯</td></tr>`;
    }
  }



  // ç»‘å®šäº‹ä»¶ï¼šå½»åº•é¿å… onclick / ä½œç”¨åŸŸ / ç¼“å­˜ç­‰å‘
  window.addEventListener('DOMContentLoaded', () => {
    $('btnReset').addEventListener('click', resetDefaults);
    $('btnCalc').addEventListener('click', runCalc);
    $('btnWord').addEventListener('click', exportWord);
    
    $('btnSens').addEventListener('click', runSensitivity);



  });
</script>

</body>
</html>
